# PostgreSQL Source

Primary relational database for the platform: **users** and **merchants** tables, loaded from CSV at init, with **Change Data Capture (CDC)** configured for logical replication (e.g. for Airbyte or other consumers).

## Schema

- **users**: `user_id` (UUID PK), `first_name`, `last_name`, `gender`, `street`, `city`, `zip`, `lat`, `long`, `job`, `dob`.
- **merchants**: `merchant` (PK), `merch_lat`, `merch_long`, `merch_zipcode`.

Data is loaded in `01_init.sql` via `COPY ... FROM` from CSVs under `init/data/` (generated by `scripts/prepare_data.py`). Ensure those CSVs exist before first run, or the init will fail.

## Init scripts (order)

Scripts in `init/` run in alphabetical order when the container is first created:

| Script | Purpose |
|--------|---------|
| **01_init.sql** | Grant replication to postgres user; create `users` and `merchants`; COPY from CSV. |
| **02_create_replication_slot.sql** | Create logical replication slot (for CDC consumers). |
| **03_setup_cdc.sql** | Set replica identity; create publication (e.g. `airbyte_publication`) for all tables; grants for replication role. |
| **04_configure_external_access.sh** | (If present) Shell script for listen address / external access. |

Postgres is started with `wal_level=logical`, `max_replication_slots`, and `max_wal_senders` so that logical replication and CDC work.

## Connection

From host: port **5433** mapped to container 5432. Use `POSTGRES_DB`, `POSTGRES_USER`, `POSTGRES_PASSWORD` from env (e.g. in docker-compose). Other services (e.g. batch-cron, update_users) connect with the same credentials; inside the Docker network use hostname `postgres` and port `5432`.

## Usage

Built and run via root `docker-compose` as the `postgres` service. Data persists in the `pgdata` volume. To reset: remove the volume and run `docker compose up -d` again so init scripts re-run (and CSVs must be present).
